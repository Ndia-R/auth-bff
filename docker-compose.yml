services:
  auth-bff:
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    ports:
      - 8888:8080
    environment:
      TZ: Asia/Tokyo
      # Keycloak Configuration
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
      KEYCLOAK_REDIRECT_URI: ${KEYCLOAK_REDIRECT_URI}
      KEYCLOAK_ISSUER_URI: ${KEYCLOAK_ISSUER_URI}
      KEYCLOAK_AUTHORIZE_URI: ${KEYCLOAK_AUTHORIZE_URI}
      KEYCLOAK_TOKEN_URI: ${KEYCLOAK_TOKEN_URI}
      KEYCLOAK_JWK_URI: ${KEYCLOAK_JWK_URI}
      # Redis Configuration
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
    volumes:
      - .:/workspace
      - gradle-cache:/home/vscode/.gradle
      # Claude Code用の永続化設定（プロジェクト固有）
      - claude-config:/home/vscode/.claude
      - claude-history:/commandhistory
      - claude-npm-global:/home/vscode/.npm-global
    depends_on:
      - redis
      - keycloak
    networks:
      - shared-network
    command: sleep infinity

  redis:
    image: redis:8.2
    ports:
      - 6379:6379
    networks:
      - shared-network

  keycloak:
    image: quay.io/keycloak/keycloak:26.3.3
    ports:
      - 8180:8080
    environment:
      TZ: Asia/Tokyo
      # 初回セットアップ用管理者アカウント
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin
      # 開発用ファイルベースDB
      KC_DB: dev-file
      # 開発環境用の緩和設定
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_HTTP_ENABLED: true
      # issuer統一のためのホスト名設定
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: 8180
      KEYCLOAK_FRONTEND_URL: http://localhost:8180

    volumes:
      - ./realm-export.json:/opt/keycloak/data/import/realm-export.json
      - keycloak-data:/opt/keycloak/data
    networks:
      - shared-network
    command: start-dev --import-realm

volumes:
  gradle-cache:
  keycloak-data:
  # Claude Code用のボリューム（プロジェクト固有）
  claude-config:      # Claude設定・認証情報
  claude-history:     # コマンド履歴
  claude-npm-global:  # npmグローバルパッケージ

networks:
  shared-network:
    external: true